# J1939 Protocol Configuration

[SFC Configuration](../core/sfc-configuration.md) > [Sources](../core/sfc-configuration.md#sources) >  [Source](../core/source-configuration.md) 



The J1939 protocol adapter enables communication with devices using the SAE J1939 protocol, which is widely used in heavy-duty vehicles, agricultural equipment, marine engines, and industrial machinery. This adapter requires a DBC (Database CAN) file that defines the protocol's Parameter Group Numbers (PGNs), Suspect Parameter Numbers (SPNs), and signal definitions - allowing proper decoding of the raw CAN messages into meaningful data. 
An open source J1939 DBC file is available at [j1939](../../examples/j1939dbc/README.md) or  https://github.com/nberlette/canbus/blob/main/dbc/j1939.dbc.

> **Note: This adapter requires SocketCAN and can only be used on POSIX-compliant operating systems like Linux.**

In order to use this adapter as in [in-process](../sfc-running-adapters.md#running-protocol-adapters-in-process) type adapter the type must be added to the [AdapterTypes](../core/sfc-configuration.md#adaptertypes) section in the [SFC configuration file](../core/sfc-configuration.md).

```json
"AdapterTypes" :{
  "J1939" : {
    "JarFiles" : ["<location of deployment>/j1939/lib"]
  },
  "FactoryClassName" : "com.amazonaws.sfc.j1939.J1939Adapter"
}
```

**Configuration:**

- [J1939SourceConfiguration](#J1939sourceconfiguration)

- [J1939ChannelConfiguration](#J1939channelconfiguration)

- [J1939AdapterConfiguration](#J1939adapterconfiguration)

- [J1939AdapterSocketConfiguration](#j1939adaptersocketconfiguration)

---

## J1939SourceConfiguration

Source configuration for the J1939 protocol adapter. This type extends the [SourceConfiguration](../core/source-configuration.md) type. 

- [Schema](#J1939sourceconfiguration-schema)
- [Examples](#J1939sourceconfiguration-examples)

**Properties:**

- [AdapterCanSocket](#adaptercansocket)
- [Channels](#channels)

- [RawFormat](#rawformat)

- [SourceAddress](#sourceaddress)

---
### AdapterCanSocket

The can socket to read from. When this value is specified the J1939 protocol adapter type, specified by the [ProtocolAdapter](../core/source-configuration.md#protocoladapter) property must contain a configuration for this value in its [CanSockets](#cansockets) property. 

**Type**: String

---

### Channels

The configuration of an J1939 channel holds configuration data to receive J1939 data from a CANbus. The element is a map indexed by the channel identifier. Channels can be "commented" out by adding a "#" at the beginning of the identifier of that channel.

**Type**: Map[String,[J1939ChannelConfiguration](#J1939channelconfiguration)]

At least 1 channel must be configured.

---

### RawFormat

Specifies the method for extracting raw channel values from a PGN message by omitting the decoding of signals for the channel s configured for this source, specified by the [Spn](#spn) property for the channels of this source.

Valid values are:

- "`Bytes`"

  Collects the raw message data as an undecoded array of bytes

- `"BytesMasked"`

  Collects the raw message data as an undecoded array of bytes only containing the bits of the signals defined by the [Spn](#spn) property of a channel.

- "`LittleEndian`"

  Decodes the message bytes as a single Long value using little-endian byte ordering

- "`LittleEndianMasked`"

  Decodes the message bytes as a single Long value using little-endian byte ordering using only the bits for the signals  defined by the [Spn](#spn) property of a channel.

- "`BigEndian`"

  Decodes the message bytes as a single Long value using big-endian byte ordering

- "`BigEndianMasked`"

  Decodes the message bytes as a single Long value using big-endian byte ordering using only the bits for the signals defined by the [Spn](#spn) property of a channel.

The RawFormat collection of a channel can be overridden at the channel level by setting the [RawFormat](#rawformat-2) property value of that channel.

**Type:** String

---

### SourceAddress

The source address can be utilized to filter data from a specific CANbus source address. If no Address is specified, data from all CANbus source addresses will be read.

To distinguish data from different CANbus source addresses, multiple sources can be configured, each with its unique SourceAddress. For these configurations, [SFC configuration templates](../sfc-configuration.md#configuration-templates) can be employed to specify the common elements of a source configuration and pass the source address as a parameter of the template.

The address can either be numeric or a hex value. Hex values need to be configured as a string with a "0x" prefix.

**Type**: Integer for decimal number, or string for hex values 

Value must be in range 0..255 (0x..0xFF)

[^top](#J1939-protocol-configuration)

### J1939SourceConfiguration Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "definitions": {
    "J1939SourceConfiguration": {
      "type": "object",
      "description": "Configuration for J1939 source adapter",
      "allOf": [
        {
          "$ref": "#/definitions/BaseSourceConfiguration"
        },
        {
          "type": "object",
          "properties": {
            "SourceAddress": {
              "type": "string",
              "description": "CANbus source address"
            },
            "AdapterCanSocket": {
              "type": "string",
              "description": "CANbus socket name configured in the J1939 adapter used by the source"
            },
            "Channels": {
              "type": "object",
              "description": "Map of J1939 channel configurations",
              "additionalProperties": {
                "$ref": "#/definitions/J1939ChannelConfiguration"
              },
              "minProperties": 1
            },
            "RawFormat": {
              "type": "string",
              "enum": ["Bytes", "BytesMasked" "LittleEndean", "LittleEndianMasked", "BigEndean", "BigEndianMasked"],
              "description": "Format for raw data collection"
              }
          },
          "required": [
            "Channels"
          ]
        }
      ]
    }
  }
}

```

### J1939SourceConfiguration Examples

Example for source reading from all source addresses

```json
{
  "ProtocolAdapter" : "J1939-adapter",
  "Channels": {
    "EEC1.EngTorqueMode": {
      "Pgn" : "EEC1",
      "Spn" : "EngTorqueMode"
    }
  }
}
```



Example of source reading from a specific source address and using a socket. Setting the CanSocket is required because the used adapter has more than one Can socket configured.

```json
{
  "SourceAddress" :"0x01",
  "CanSocket" : "can0",
  "ProtocolAdapter" : "J1939-adapter",
  "Channels": {
    "EEC1.EngTorqueMode": {
      "Pgn" : "EEC1",
      "Spn" : "EngTorqueMode"
    }
  },
  "Metadata" :{
    "Source" : "Engine-01"
  }
}
```





## J1939ChannelConfiguration

[SFC Configuration](../core/sfc-configuration.md) > [Sources](../core/sfc-configuration.md#sources) > [Source](../core/source-configuration.md)  > [Channels](../core/source-configuration.md#channels) > [Channel](../core/channel-configuration.md)

The J1939ChannelConfiguration type extends the [ChannelConfiguration](../core/channel-configuration.md) class with channel properties for the J1939 protocol adapter.

- [Schema](#J1939channelconfiguration-schema)
- [Examples](#J1939channelconfiguration-examples)

**Properties:**
- [Pgn](#pgn)
- [RawFormat](#rawformat-2)
- [Spn](#spn)

---
### Pgn
The Parameter Group Number (PGN) identifies a specific group of parameters or signals in the J1939 protocol. Each PGN represents a unique message type containing one or more signals (SPNs) transmitted on the CAN bus. The PGN can be specified in one of three formats:
- As a decimal number (e.g., 61444)
- As a hexadecimal value with "0x" prefix (e.g., "0xF004")
- As the symbolic name defined in the BO_ entry in the DBC file (e.g., "EEC1")

Entry in DBC file for examples above

`BO_ 2364540158 EEC1: 8 Vector__XXX`

**Type**: Integer or String

---

### RawFormat

Specifies the method for extracting raw channel values from a PGN message by omitting the decoding of signals for the channel specified by the [Spn](#spn) property.  

Valid values are:

- "`Bytes`"

   Collects the raw message data as an undecoded array of bytes

- `"BytesMasked"`:

  Collects the raw message data as an undecoded array of bytes only containing the bits of the signals defined by the [Spn](#spn) property of the channel.

- "`LittleEndean`":

  Decodes the message bytes as a single Long value using little-endian byte ordering

- "`LittleEndeanMasked`"

  Decodes the message bytes as a single Long value using little-endian byte ordering using only the bits for the signals defined by the [Spn](#spn) property of the channel.

- "`BigEndean`"

  Decodes the message bytes as a single Long value using big-endian byte ordering

- "`BigEndeanMasked`"

   Decodes the message bytes as a single Long value using big-endian byte ordering using only the bits for the signalsdefined by the [Spn](#spn) property of the channel.

When this value is set, the [RawFormat](#rawformat-1) that can is configured for the  source of the chhannel will be overridden.

**Type:** String

---
### Spn
The Parameter Suspect Number (SPN) identifies specific signals within a PGN message. The SPN field can be configured in three ways:
- A single SPN to retrieve one specific signal value
- A comma-separated list of SPNs (e.g., "EngSpeed, ActualEnginePercentTorque" ) to retrieve multiple selected signals
- Left empty to retrieve all signals defined in the DBC file for the specified PGN

A SPN can be specified in one of three formats:

- As a decimal number (e.g., 190)
- As a hexadecimal value with "0x" prefix (e.g., "0xBE")
- As the name defined in the BA_ "SPN" entry in the DBC file (e.g., "EngSpeed")

Entry in DC file for examples above  `BA_ "SPN" SG_ 2364540158 EngSpeed 190;`

When multiple signals are retrieved (either through a comma-separated list or by leaving SPN empty), the values are returned in a structured format with each signal's value accessible by its name.

**Type:** Integer, String (Stings can contain multiple values as a comma separated list)



[^top](#J1939-protocol-configuration)

### J1939ChannelConfiguration Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "description": "Configuration for J1939 channel",
  "allOf": [
    {
      "$ref": "#/definitions/ChannelConfiguration"
    },
    {
      "type": "object",
      "properties": {
        "Pgn": {
          "type": [
            "number",
            "string"
          ],
          "description": "Parameter Group Number (PGN) as decimal number, hex string with '0x' prefix, or PGN name"
        },
        "Spn": {
          "type": [
            "number",
            "string"
          ],
          "description": "Parameter Suspect Number (SPN) as decimal number, hex string with '0x' prefix, or SPN name"
        },
        "RawFormat": {
          "type": "string",
          "enum": ["Bytes", "BytesMasked" "LittleEndean", "LittleEndianMasked", "BigEndean", "BigEndianMasked"],
          "description": "Format for raw data collection"
        }
      },
      "required": [
        "Pgn"
      ],
      "oneOf": [
        {
          "required": ["Spn"],
          "not": {
            "required": ["RawFormat"]
          }
        },
        {
          "required": ["RawFormat"],
          "not": {
            "required": ["Spn"]
          }
        }
      ]
    }
  ]
}

```



[^top](#J1939-protocol-configuration)



### J1939ChannelConfiguration Examples

All values for PGN EEC1, specified by PGN number 61444

```json
{
  "EEC1-ALL": [
    "Pgn": 61444
  ]
}
```



All values for PGN EEC1, specified by PGN symbolic name

```json
{
  "EEC1-ALL": [
    "Pgn": "EEC1"
  ]
}
```



Engine speed value from PGN EEC1

```json
{
  "EngSpeed": [
    "Pgn": "EEC1",
    "Spn" : "EngSpeed"
  ]
}
```



Engine speed value from PGN EEC1 using specific name in output

```json
{
  "EEC1.EngSpeed": [
    "Pgn": "EEC1",
    "Spn" : "EngSpeed"
    "Name" : "EngineSpeed"
  ]
}
```



Engine speed value from PGN EEC1 using specific name in output

```json
{
  "EEC1.EngSpeed": [
    "Pgn": "EEC1",
    "Spn" : "EngSpeed"
    "Name" : "EngineSpeed"
  ]
}
```



Engine starter mode and speed selected from EEC1

```json
{
  "EEC1": [
    "Pgn": "EEC1",
    "Spn" : "EngSpeed, EngStarterMode"
  ]
}
```



Engine starter mode and speed selected from EEC1 using numeric values for PGN and SPN

```json
{
  "EEC1": [
    "Pgn":  61444,
    "Spn" : "1675, 190"
  ]
}
```



[^top](#J1939-protocol-configuration)



## J1939AdapterConfiguration

[SFC Configuration](../core/sfc-configuration.md) > [ProtocolAdapters](../core/sfc-configuration.md#protocoladapters) > [Adapter](../core/protocol-adapter-configuration.md) 

J1939AdapterConfiguration extends the [AdapterConfiguration](../core/protocol-adapter-configuration.md) with properties for the J1939 Protocol adapter.

- [Schema](#J1939adapterconfiguration-schema)
- [Examples](#J1939adapterconfiguration-examples)

**Properties:**

- [CanSockets](#cansockets)
- [DbcFile](#dbcfile)
- [MaxRetainPeriod](#maxretainperiod)
- [MaxRetainSize](#maxretainsize)
- [ReadMode](#readmode)
- [ReadTimestamp](#readtimestamp)
- [ReceivedDataChannelSize](#receiveddatachannelsize)
- [ReceivedDataChannelTimeout](#receiveddatachanneltimeout)
- [WaitAfterOpenError](#waitafteropenerror)
- [WaitAfterReadError](#waitafterreaderror)

---

### CanSocket

Obsolete, replaced by [CanSockets](#cansockets) and J1939Channel [CanSocket](#cansocket) to support  multi can socket reading. 

---
### CanSockets
The names of the SocketCAN interfaces to read CAN messages from. On Linux systems, this is typically "can0" for the first CAN interface, but the actual name depends on how the CAN interface is configured in the system. The interfaces must be properly set up and enabled in the operating system before the adapter can use it. For virtual CAN interfaces used for testing, names like "vcan0" are commonly used. 

There must be at least one item in the list.

The adpter will try to read from all interfaces in this list which are refered in the [CanSocket](#cansocket) property of a configured [source](#J1939sourceconfiguration). If the interface is not found then it will pause reading fron the interface for a period configured in the [WaitAfterOpenError](#waitafteropenerror) property.



**Type**: List of String

---

### DbcFile

Path to the DBC (Database CAN) file containing J1939 protocol specifications. The DBC file defines the protocol's Parameter Group Numbers (PGNs), Suspect Parameter Numbers (SPNs), and signal definitions required to decode CAN messages. The file must be readable by the adapter and contain valid J1939 message definitions. Both absolute and relative paths are supported, with relative paths being resolved relative to the configuration file's location.

**Type :** String

---

### MaxRetainPeriod

When [ReadMode](#readmode) is `KeepAll` this parameter can be used to restrict the period in milliseconds for which values are stored.

Maximum time period (in milliseconds) to retain channel values in memory. When reading J1939 signals, the adapter maintains the most recently received value for each configured channel. This property sets the maximum duration for which values are retained. Values older than this period will be discarded, helping to ensure that stale data is not used in processing. Default value is 3,600,000 milliseconds (1 hour).

**Type**: Integer

The default value is 3.600.00 (1 hour). If set to 0 there is no maximum period.

---

### MaxRetainSize

When [ReadMode](#readmode) is `KeepAll` this parameter can be used to restrict the maximum number of stored values.

Maximum number of unique channel values to retain in memory. When reading J1939 signals, the adapter maintains the most recently received value for each configured channel. This property sets the upper limit for the number of retained channel values to prevent excessive memory usage. If the limit is reached, the oldest values will be discarded as new ones arrive. Default value is 10000.

**Type**: Integer

The default value is 10000.
If set to 0 there is no maximum number of values.

---

### ReadMode

Read mode of the adapter. Set to "KeepAll" to collect all messages on subscribed topics during a read interval.
Set to "KeepLast", which is the default, to keep only the last received message.

**Type**: String


- `KeepLast` to collect last values received in read interval (Default)
- `KeepAll` to collect  values received in read interval up to the maximum specified by [MaxRetainSize](#maxretainsize) values of not older than specified by [MaxRetainPeriod](#maxretainperiod)



---

### ReadTimestamp

When set to true (default), the adapter reads timestamps directly from the SocketCAN interface, providing the exact time when the CAN frame was captured by the hardware. When set to false, the adapter uses the local system time when the message is processed by the software. Using SocketCAN timestamps generally provides more accurate timing information, especially in high-traffic scenarios or when message processing is delayed.

**Type**: Boolean  

**Default**: true


---
### ReceivedDataChannelSize
Size of internal buffer to receive data for topic subscriptions

**Type**: Int

Default is 1000

---
### ReceivedDataChannelTimeout
Timeout in milliseconds to send data to internal buffer for received data for topic subscriptions

**Type**: Int

Default is 1000

---

### WaitAfterOpenError

Time period in milliseconds to wait after encountering opening a SocketCAN interface. This delay helps prevent excessive CPU usage and log spam in error conditions, such as when the CAN interface is temporarily unavailable or experiencing communication issues. The adapter will pause for this duration before attempting to reopen the connection or resume reading operations.

**Type**: Integer  
**Default**: 60000

---

### WaitAfterReadError

Time period in milliseconds to wait after encountering an error while opening or reading from the SocketCAN interface. This delay helps prevent excessive CPU usage and log spam in error conditions, such as when the CAN interface is temporarily unavailable or experiencing communication issues. The adapter will pause for this duration before attempting to reopen the connection or resume reading operations.

**Type**: Integer  
**Default**: 10000



[^top](#J1939-protocol-configuration)

### J1939AdapterConfiguration Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "description": "Configuration for J1939 protocol adapter",
  "allOf": [
    {
      "$ref": "#/definitions/AdapterConfiguration"
    },
    {
      "type": "object",
      "properties": {
        "CanSockets": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/J1939AdapterSocket"
          },
          "minProperties": 1,
          "description": "Map of SocketCAN interface configurations indexed by string identifiers"
        },
        "DbcFile": {
          "type": "string",
          "description": "Path to the DBC (Database CAN) file containing J1939 protocol specifications"
        },
        "MaxRetainSize": {
          "type": "integer",
          "description": "Maximum number of unique channel values to retain in memory",
          "minimum": 1,
          "default": 10000
        },
        "MaxRetainPeriod": {
          "type": "integer",
          "description": "Maximum time period (in milliseconds) to retain channel values",
          "minimum": 1,
          "default": 3600000
        },
        "ReceivedDataChannelSize": {
          "type": "integer",
          "description": "Size of the channel buffer for received data",
          "minimum": 1,
          "default": 1000
        },
        "WaitAfterReadError": {
          "type": "integer",
          "description": "Time in milliseconds to wait after encountering a read error",
          "minimum": 0,
          "default": 10000
        },
        "WaitAfterOpenError": {
          "type": "integer",
          "description": "Time in milliseconds to wait after encountering an error opening a can socket interface",
          "minimum": 0,
          "default": 10000
        }
      }
    }
  ],
  "required": [
    "CanSockets",
    "DbcFile"
  ],
  "definitions": {
    "J1939AdapterSocket": {
      "type": "object",
      "properties": {
        "socketName": {
          "type": "string",
          "description": "Name of the SocketCAN interface (e.g., 'can0', 'can1')"
        }
      },
      "required": ["socketName"]
    }
  }
}

```

### J1939AdapterConfiguration Examples

Configuration that retains the most recent value received for a channel during a specified reading period.

```json
{
  "AdapterType" : "J1939",
  "CanSockets": {
      "Can0" : {
         "SocketName" : "can0"
      },
      "Can1" : {
          "SocketName" : "can1"
       }
  },
  "DbcFile": "/etc/sfc/j1939_db.dbc",
  "ReadMode" : "KeepLast"
}
```



Configuration for storing all values received during a specified reading period, subject to constraints such as the number of values or the duration of the period.

```json
{
  "AdapterType": "J1939",
  "CanSockets": {
      "Can0" : {
         "SocketName" : "can0"
      }
  },
  "DbcFile": "/etc/sfc/j1939_db.dbc",
  "ReadMode": "KeepAll",
  "MaxRetainSize": 50000,
  "MaxRetainPeriod": 3600000
}
```

Configuration for testing with 2 virtual CAN interfaces

```json
{
  "  "CanSockets": {
      "Can0" : {
         "SocketName" : "vcan0"
      },
      "Can1" : {
          "SocketName" : "vcan1"
      }
  },
  "DbcFile": "/tmp/test_j1939.dbc",
}
```

[^top](#J1939-protocol-configuration)



### **J1939AdapterSocketConfiguration**

The J139SocketAdapter hold the configuration for a CABbus socket read by the adapter.

- [Schema](#J1939adaptersocketconfiguration-schema)
- [Examples](#j1939adaptersocketconfiguration-example)

**Properties:**

- [CanSockets](#cansockets)
- [DbcFile](#dbcfile)
- [MaxRetainPeriod](#maxretainperiod)
- [MaxRetainSize](#maxretainsize)
- [ReadMode](#readmode)
- [ReadTimestamp](#readtimestamp)
- [ReceivedDataChannelSize](#receiveddatachannelsize)
- [ReceivedDataChannelTimeout](#receiveddatachanneltimeout)
- [WaitAfterOpenError](#waitafteropenerror)
- [WaitAfterReadError](#waitafterreaderror)



### J1939AdapterSocketConfiguration schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "title": "J1939AdapterSocketConfiguration",
  "description": "Configuration for a J1939 adapter socket",
  "properties": {
    "SocketName": {
      "type": "string",
      "minLength": 1,
      "description": "Name of the SocketCAN interface"
    }
  },
  "required": ["SocketName"]
}
```



### J1939AdapterSocketConfiguration example

```json
{
  "SocketName": "can0"
}
```

