# Running SFC targets

- [Running targets as an IPC Service](#running-targets-as-an-ipc-service)
- [Running targets in-process](#running-targets-in-process)

# Running targets as an IPC Service

The adapters have a service wrapper that enables these targets can be executed as an IPC Service process. For each
target, a tar file is generated by the build process that includes the application script file to start the service, as
well as all required library files. The application tar file contains script files (`bin/<targettype>`
*and* `bin/<targettype>.bat`) to launch the applications, and all required libraries (/lib/*.jar)


| Parameter   | Description                                                                                                                                                                                                                                                                                                                                                                                          |
|-------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| -config     | Name of the configuration file. The only value used from the configuration file is the port number the process will listen on for IPC requests. The SFC core will send an initialization request to the service on this port with the configuration data for the service to initialize its communication with the actual output of the target.                                                       |
| -connection | Security level used to secure traffic between SFC core and target service. PlainText : No encryption ServerSideTLS : Data is encrypted, requires -cert and -key parameters MutualTLS : Data is encrypted, required -cert, ca and -key parameters The connection type must match the connection type, as set to the ConnectionType attribute for the client, to communicates with the target service. |
| -cert       | Server certificate file to secure IPC (gRPC) traffic for connection types ServerSideTLS and MutualTLS                                                                                                                                                                                                                                                                                                |
| -key        | Server private file to secure IPC (gRPC) traffic for connection types ServerSideTLS and MutualTLS                                                                                                                                                                                                                                                                                                    |
| -ca         | CA certificate file to secure IPC (gRPC) traffic for connection type MutualTLS                                                                                                                                                                                                                                                                                                                       |
| -envport    | The name of the environment variable that contains the port number for the service to listen on for requests.                                                                                                                                                                                                                                                                                        |
| -error      | Set log output level to error level. (Error message only)                                                                                                                                                                                                                                                                                                                                            |
| -h, -help   | Shows command line parameter help.                                                                                                                                                                                                                                                                                                                                                                   |
| -info       | Set log output level to info level. (Info, warning and error messages)                                                                                                                                                                                                                                                                                                                               |
| -key        | Key file to secure IPC (gRPC) traffic using SSL (optional).                                                                                                                                                                                                                                                                                                                                          |
| -nocolor    | Disable color coded output to console.                                                                                                                                                                                                                                                                                                                                                               |
| -port       | port number for the service to listen on for requests.                                                                                                                                                                                                                                                                                                                                               |
| -target     | Target identifier                                                                                                                                                                                                                                                                                                                                                                                    |
| -trace      | Set log output level to most detailed trace level (Info, warning, error, and detailed trace messages)                                                                                                                                                                                                                                                                                                |
| -warning    | Set log output level to warning level. (Error and warning messages)                                                                                                                                                                                                                                                                                                                                  |

The applications do have all the following command line parameters in common.

| Parameter   | Description                                                                                                                                                                                                                                                                                                                                                                                          |
|-------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| -config     | Name of the configuration file. The only value used from the configuration file is the port number the process will listen on for IPC requests. The SFC core will send an initialization request to the service on this port with the configuration data for the service to initialize its communication with the actual output of the target.                                                       |
| -connection | Security level used to secure traffic between SFC core and target service. PlainText : No encryption ServerSideTLS : Data is encrypted, requires -cert and -key parameters MutualTLS : Data is encrypted, required -cert, ca and -key parameters The connection type must match the connection type, as set to the ConnectionType attribute for the client, to communicates with the target service. |
| -cert       | Server certificate file to secure IPC (gRPC) traffic for connection types ServerSideTLS and MutualTLS                                                                                                                                                                                                                                                                                                |
| -key        | Server private file to secure IPC (gRPC) traffic for connection types ServerSideTLS and MutualTLS                                                                                                                                                                                                                                                                                                    |
| -ca         | CA certificate file to secure IPC (gRPC) traffic for connection type MutualTLS                                                                                                                                                                                                                                                                                                                       |
| -envport    | The name of the environment variable that contains the port number for the service to listen on for requests.                                                                                                                                                                                                                                                                                        |
| -error      | Set log output level to error level. (Error message only)                                                                                                                                                                                                                                                                                                                                            |
| -h, -help   | Shows command line parameter help.                                                                                                                                                                                                                                                                                                                                                                   |
| -info       | Set log output level to info level. (Info, warning and error messages)                                                                                                                                                                                                                                                                                                                               |
| -key        | Key file to secure IPC (gRPC) traffic using SSL (optional).                                                                                                                                                                                                                                                                                                                                          |
| -nocolor    | Disable color coded output to console.                                                                                                                                                                                                                                                                                                                                                               |
| -port       | port number for the service to listen on for requests.                                                                                                                                                                                                                                                                                                                                               |
| -target     | Target identifier                                                                                                                                                                                                                                                                                                                                                                                    |
| -trace      | Set log output level to most detailed trace level (Info, warning, error, and detailed trace messages)                                                                                                                                                                                                                                                                                                |
| -warning    | Set log output level to warning level. (Error and warning messages)                                                                                                                                                                                                                                                                                                                                  |

The port number, used by the service, can be specified using different methods which are applied in the following order

- The value of the` -port` command line parameter
- The value of the environment variable specified by the `-envport` parameter
- From the configuration file, specified by the `-config` parameter, the port number for the server referred to in the
  target element will be used. As a configuration can contain multiple targets the following methods are used to
  determine the target.
    - The value of the -target command line parameter
    - If the configuration file contains a single target then that target is used

To protect the ICP traffic between the core and the adapter SSL can be used. For this, both the -cert and the -key
parameter must be used to specify the pathname to the certificate and the key file. If the -conf parameter is used then
the values of the Cert and Key elements of the server referred to in the ProtocolSource/Server element will be used.


# Running targets in-process

To run targets in the same process as the SFC core, they need to be implemented for the same JDK as used for the core.
To make it possible to add a new target without making changes to the SFC code, there are no links in the core to the
libraries that implement the target. In the configuration of an in-process target type, the pathnames of the jar files
that contain the classes that implement the target need to be explicitly configured. When the SFC core creates an
instance of the target, it loads the configured jar files and uses a static factory method to create the actual
instance. The name of the factory class, which could be the actual target class itself, needs to be configured as well.

The jar files are part of the target deployment and can be found in the lib directory of the deployment package. To
specify the path to the jar files it is recommended to use a placeholder, instead of hard-coding, the directory where
the adapter, and targets, are deployed and set an environment variable for this directory.

**Example configurations for in-process targets configuration with environment variable placeholders:**

- Used environment variable is `SFC_DEPLOYMENT_DIR`: Directory in which deployment packed is deployed, with a
  subdirectory for each target.
- Configuration is using the debug, MQTT and OPCUA targets


```json
    "TargetTypes": {
    "DEBUG-TARGET": {
      "JarFiles": [
        "${SFC_DEPLOYMENT_DIR}/debug-target/lib"
      ],
      "FactoryClassName": "com.amazonaws.sfc.debugtarget.DebugTargetWriter"
    },
    "AWS-IOT-CORE": {
      "JarFiles": [
        "${SFC_DEPLOYMENT_DIR}/aws-iot-core-target/lib"
      ],
      "FactoryClassName": "com.amazonaws.sfc.awsiotcore.AwsIotCoreTargetWriter"
    },
    "MQTT-TARGET": {
      "JarFiles": [
        "${SFC_DEPLOYMENT_DIR}/mqtt-target/lib/"
      ],
      "FactoryClassName": "com.amazonaws.sfc.awsiot.mqtt.MqttTargetWriter"
    }
  }
```
