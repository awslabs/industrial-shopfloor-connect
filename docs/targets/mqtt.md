# MQTT Target

[SFC Configuration](../core/sfc-configuration.md) > [Targets](../core/sfc-configuration.md#targets) >  [Target](../core/target-configuration.md) 

The SFC MQTT target adapter enables publishing collected data to MQTT brokers using configurable topic patterns. Topics can be dynamically constructed using target data and  metadata from the source readings. The adapter supports various MQTT protocol configurations, authentication methods, and quality of service (QoS) levels for reliable message delivery. 

In order to use this target as in [in-process](../sfc-running-targets.md#running-targets-in-process) type target the type must be added to the [TargetTypes](../core/sfc-configuration.md#TargetTypes) section in the [SFC configuration file](../core/sfc-configuration.md).

```json
"TargetTypes" :{
   "MQTT_TARGET": {
      "JarFiles" : ["<location of deployment>/mqtt-target/lib"],
      "FactoryClassName": "com.amazonaws.sfc.mqtt.MqttTargetWriter"
   }
}
```

## MqttTargetConfiguration

MqttTargetConfiguration extends the type TargetConfiguration with specific configuration data for connecting to and sending to MQTT topics. The Targets configuration element can contain entries of this type; the TargetType of these entries must be set to **"MQTT-TARGET"**.

- [Schema](#mqtttargetconfiguration-schema)
- [Examples](#mqtttargetconfiguration-examples)

**Properties:**
- [AlternateTopicName](#alternatetopicname)
- [BatchCount](#batchcount)
- [BatchInterval](#batchinterval)
- [BatchSize](#batchsize)
- [Certificate](#certificate)
- [ClientId](#clientid)
- [Compression](#compression)
- [ConnectRetries](#connectretries)
- [Connection](#connection)
- [ConnectionTimeout](#connectiontimeout)
- [EndPoint](#endpoint)
- [Formatter](#formatter)
- [MaxPayloadSize](#maxpayloadsize)
- [Password](#password)
- [Port](#port)
- [PrivateKey](#privatekey)
- [PublishTimeout](#publishtimeout)
- [QoS](#qos)
- [Retain](#retain)
- [RootCA](#rootca)
- [SslServerCertificate](#sslservercertificate)
- [Template](#template)
- [TopicName](#topicname)
- [Username](#username)
- [WaitAfterConnectError](#waitafterconnecterror)
- [WarnAlternateTopicName](#warnalternatetopicname)

---
### AlternateTopicName
An alternative topic name or template to use when the primary [TopicName](#topicname) contains unmapped placeholder variables that cannot be resolved. This serves as a fallback publishing destination when dynamic topic name construction fails.

**Type**: String

---
### BatchCount
The maximum number of messages to accumulate in the buffer before triggering a batch publish to the MQTT topic. When this count is reached, all buffered messages are sent as an array in a single MQTT message.

Batching is triggered when any configured threshold (BatchCount, [BatchSize](#batchsize), or [BatchInterval](#batchinterval)) is reached

**Type**: Int

---
### BatchInterval
The maximum time in milliseconds to hold messages in the buffer before publishing them as a batch to the MQTT topic, regardless of whether [BatchSize](#batchcount) or [BatchCount](#batchcount) limits have been reached.

Batching is triggered when any configured threshold ([BatchCount](#batchcount), [BatchSize](#batchsize), or BatchInterval) is reached

**Type**: Int

---
### BatchSize
The maximum total size in kilobytes of uncompressed message payloads to accumulate before triggering a batch publish to the MQTT topic. When this size threshold is reached, all buffered messages are sent as an array in a single MQTT message.

Batching is triggered when any configured threshold ([BatchCount](#batchcount), BatchSize, or [BatchInterval](#batchinterval)) is reached

**Type**: Int

---
### Certificate
The file system path to the client certificate file used for authentication with the MQTT broker when certificate-based authentication is enabled.

 Only when using certificate-based authentication

**Type**: String

---

### ClientId

The Client ID is a unique identifier that is used to connect to the MQTT broker. If no Client ID is specified, a unique client ID is generated by the target. Specify the Client ID to ensure that it is used when sending messages to your Broker. This property needs to be configured when integrating with a Broker on an AWS IoT Greengrass V2 Device. The `aws.greengrass.clientdevices.Auth` component expects the MQTT Client ID to match the AWS IoT Thing name.

**Type**: String

---
### Compression
The compression algorithm to apply to MQTT message payloads before publishing to the broker. Compressing messages can reduce bandwidth usage and transmission time.

**Type:** String

Possible values:

- "None" (Default)
- "Zip"
- "GZip"

---
### ConnectRetries
The maximum number of attempts to establish a connection with the MQTT broker when the initial connection fails.

**Type**: Int

Default is 10

---
### Connection
Specifies the type of connection security to use when connecting to the MQTT broker. 

Possible values:
- "PlainText": Unencrypted connection, this is the default
- "ServerSideTLS": TLS encryption with server certificate validation
- "MutualTLS": TLS encryption with both server and client certificate validation

**Type**: String

---
### ConnectionTimeout
The maximum time in seconds to wait for establishing a connection with the MQTT broker before timing out.

**Type**: Int

Default is 10 seconds

---
### EndPoint
The network address of the MQTT broker to connect to.

**Type**: String

- Port number is optional in the endpoint string (see [Port](#port) property)
- If protocol scheme is omitted, it will be automatically added based on Connection type:
  - PlainText: "tcp://" prefix
  - ServerSideTLS or MutualTLS: "ssl://" prefix

For AWS IoT Core, use the ATS endpoint for your account To get the ATS endpoint for an account use the AWS CLI command
```console
aws iot describe-endpoint --endpoint-type iot:Data-ATS
```
https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iot/describe-endpoint.html

---

### Formatter

Configuration allows for custom formatting of data written by a target. A [custom formatter](../sfc-extending.md#custom-formatters), implemented as a JVM class, converts a sequence of target data messages into a specific format and returns the formatted data as an array of bytes.

When a formatter is used, a [template](#template) configured for that target is ignored.

**Type:** [InProcessConfiguration](../core/in-process-configuration.md)


---
### MaxPayloadSize
The maximum size in kilobytes allowed for a single MQTT message payload.

- When compression is enabled, the original uncompressed payload size may exceed this limit
- For batched messages without compression, reaching this size limit will trigger sending the batch
- Used as a threshold for batch publishing when batching is enabled

**Type**: Int


---
### Password
The password credential for authenticating with the MQTT broker when using username/password authentication.

[Username](#username) and password should not be included as clear text in the configuration. It is strongly recommended to use placeholders and use the SFC integration with the [AWS secrets manager](../core/secrets-manager-configuration.md).

**Type**: String

---
### Port
The TCP port number used to connect to the MQTT broker. 

**Type**: Integer

Commonly port numbers are

- 1883 for PlainText
- 8883 for ServerSideTLS
- 8884 for MutualTLS.
- 443 for AWS IoT Core endpoints

If no port number is specified, then the [EndPoint](#endpoint) address is searched for a training port number.

---
### PrivateKey
The file system path to the private key file used for client authentication when using certificate-based authentication with the MQTT broker. 

Only when using certificate-based authentication (MutualTLS)

**Type**: String

---
### PublishTimeout
The maximum time in seconds to wait for a message to be published to the MQTT broker before timing out.

**Type**: Long

Default is 10 seconds

---
### QoS
The MQTT Quality of Service (QoS) level for message delivery. 

- 0: At most once (Fire and forget), the default.
- 1: At least once (Guaranteed delivery, but possible duplicates)
- 2: Exactly once (Guaranteed delivery exactly one time)

**Type**: Integer



---
### Retain
Controls whether messages should be retained by the MQTT broker. 

When set to true, the broker will store the last message published to each topic. New subscribers to these topics will immediately receive the most recent retained message, even if it was published before they subscribed.

**Type**: Boolean

Default is false

---
### RootCA
The file system path to the Root Certificate Authority (CA) certificate file.

When using secure connections (TLS/SSL) to validate the broker's identity.

**Type**: String

---
### SslServerCertificate
The file system path to the server certificate file used to verify the MQTT broker's identity for ServerSideTLS and MutualTLS connection types.

Used to authenticate and verify the identity of the MQTT broker during secure connections.

**Type**: String

---

### Template

Specifies the file path to an [Apache velocity](https://velocity.apache.org/)  template used for  [transforming the output data](../sfc-target-templates.md) target output data. This optional setting enables custom formatting of data before it is sent to the target. Available context variables include:

- $schedule
- $sources
- $metadata
- $serial
- $timestamp
- names specified in ElementNames configuration
- $tab (for inserting tab characters)

Pathname to file containing an [Apache velocity](https://velocity.apache.org/) template that can be applied to [transform the output data](../sfc-target-templates.md) of the target.

The following [Velocity tools](https://velocity.apache.org/tools/3.1/tools-summary.html) can be used in the transformation template:

- $datetool
- $collection
- $context
- $math
- $number

Additional epoch timestamp values can be added to the data used for the transformation by setting the [TemplateEpochTimestamp](../core/target-configuration.md#templateepochtimestamp) property to true,

For targets where the data does not require specific output format, the data is serialized as [JSON data](../sfc-data-format.md#sfc-output-data-schemas).

When a custom [formatter](#formatter) is configured for a target then this property is ignored.

**Type**: String

---
### TopicName
The MQTT topic name or topic name template for publishing messages.

**Type**: String

A template can be used for the topicName to render the actual topic name using placeholders. In this template, 
besides placeholders for environment variables (${name}), the following placeholders are available:

- %schedule%
- %target%
- %source%
- %channel%

To utilize the metadata values at the source or channel level of the target data, the name of the metadata value can be utilized with a '%' prefix and postfix.

Value placeholders can be employed to incorporate additional topic levels or grouping values to a specific topic.

Template examples:

- plant1-**%source%** : Values from each source will be published to a topic for that source
- plant1-**%line%**   : Values from all sources will be grouped by the value of the %line% metadata and published to a topic for that value

In case a placeholder is not resolved, when a value for a used placeholder is part of the data,
then an alternative topic name can be configured by setting the name of that topic to the [AlternateTopicName](#alternatetopicname) setting.

Note that the use of placeholders to send data to specific topics will result in additional publish calls to the broker.



---
### Username
The username credential for authenticating with the MQTT broker when using username/password authentication

Username and [password](#password) should not be included as clear text in the configuration. It is strongly recommended to use placeholders and use the SFC integration with the [AWS secrets manager](../core/secrets-manager-configuration.md).

**Type**: String

---
### WaitAfterConnectError
The delay period in seconds before attempting to reconnect after a failed connection to the MQTT broker.

**Type**: Int

Default is 60 seconds

---
### WarnAlternateTopicName
Controls whether a warning message should be generated when data is published to the alternate topic name.

When enabled, logs a warning message if the system falls back to using the [AlternateTopicName](#alternatetopicname) due to unresolved placeholders in the main topic name

**Type**: Boolean

Default is tue



### MqttTargetConfiguration Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "MqttTargetConfiguration",
  "type": "object",
  "allOf": [
    {
      "$ref": "#/definitions/TargetConfiguration"
    },
    {
      "type": "object",
      "properties": {
        "AlternateTopicName": {
          "type": "string",
          "description": "Alternate topic name when dynamic propery has unresolved placeholders"
        },
        "BatchCount": {
          "type": "integer",
          "description": "Number of messages to batch before publishing"
        },
        "BatchInterval": {
          "type": "integer",
          "description": "Interval in milliseconds between batch publishes"
        },
        "BatchSize": {
          "type": "integer",
          "description": "Maximum size of batched messages in bytes"
        },
        "Certificate": {
          "type": "string",
          "description": "Client certificate for TLS authentication"
        },
        "ClientId":{
           "type": "string",
           "description": "Client id for MQTT broker connection "
        },
        "Compression": {
          "type": "string",
          "description": "Type of message compression",
          "enum": ["None", "Zip", "GZip"],
          "default": "None"
        },
        "ConnectRetries": {
          "type": "integer",
          "description": "Number of connection retry attempts"
        },
        "Connection": {
          "type": "string",
          "description": "Type of connection security",
          "enum": ["PlainText", "ServerSideTLS", "MutualTLS"],
          "default": "PlainText"
        },
        "ConnectionTimeout": {
          "type": "integer",
          "description": "Connection timeout in milliseconds"
        },
        "EndPoint": {
          "type": "string",
          "description": "MQTT broker endpoint"
        },
        "MaxPayloadSize": {
          "type": "integer",
          "description": "Maximum size of message payload in bytes"
        },
        "Password": {
          "type": "string",
          "description": "Password for authentication"
        },
        "Port": {
          "type": "integer",
          "description": "Port number for MQTT connection"
        },
        "PrivateKey": {
          "type": "string",
          "description": "Private key for TLS authentication"
        },
        "PublishTimeout": {
          "type": "integer",
          "description": "Timeout for publish operations in milliseconds"
        },
        "QoS": {
          "type": "integer",
          "description": "Quality of Service level",
          "enum": [0, 1, 2],
          "default": 0
        },
        "Retain": {
          "type": "boolean",
          "description": "Whether messages should be retained by broker"
        },
        "RootCA": {
          "type": "string",
          "description": "Root CA certificate"
        },
        "SslServerCertificate": {
          "type": "string",
          "description": "SSL server certificate"
        },
        "TopicName": {
          "type": "string",
          "description": "Primary topic name"
        },
        "Username": {
          "type": "string",
          "description": "Username for authentication"
        },
        "WaitAfterConnectError": {
          "type": "integer",
          "description": "Wait time in milliseconds after connection error"
        },
        "WarnAlternateTopicName": {
          "type": "boolean",
          "description": "Whether to warn when using alternate topic"
        }
      },
      "required": ["EndPoint", "TopicName"]
    }
  ]
}

```

### MqttTargetConfiguration Examples

MQTT Configuration using (secret) placeholders for username and password

```json
{
  "TargetType" : "MQTT-TARGET",
  "EndPoint": "mqtt.example.com",
  "Port": 1883,
  "TopicName": "sensors/data",
  "QoS": 1,
  "Username": "${username}",
  "Password": "${password}",
  "ConnectionTimeout": 30000
}
```

Secure MQTT with TLS:

```json
{
  "TargetType" : "MQTT-TARGET"
  "EndPoint": "secure-mqtt.example.com",
  "Port": 8883,
  "TopicName": "production/metrics",
  "Connection": "MutualTLS",
  "Certificate": "/path/to/client-cert.pem",
  "PrivateKey": "/path/to/private-key.pem",
  "RootCA": "/path/to/root-ca.pem",
  "QoS": 2,
  "Compression": "GZip",
  "BatchSize": 1024,
  "BatchInterval": 5000
}
```

Configuration  with dynamic topic names from target- and metadata values

```json
{
  "TargetType" : "MQTT-TARGET"
  "EndPoint": "mqtt.internal.com",
  "Port": 1883,
  "TopicName": "data/%location%/%line%/%source%",
  "AlternateTopicName": "data/sensors",
  "WarnAlternateTopicName": true
}
```



[^top](#mqtt-target)

