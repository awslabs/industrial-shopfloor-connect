# Running SFC protocol adapters

- [Running the JVM protocol adapters as an IPC Service](#running-the-jvm-protocol-adapters-as-an-ipc-service)
- [Running protocol adapters in-process](#running-protocol-adapters-in-process)



## Running the JVM protocol adapters as an IPC Service

The adapters have a service wrapper that enables these adapters can be executed as an IPC Service process. For each
adapter, a tar file is generated by the build process that includes the application script file to start the service, as
well as all required library files. The application tar file contains script files (`bin/<adapter type>`
and `bin/<adaptertype>.bat`) to launch the applications, and all required libraries (`/lib/*.jar`).

| Protocol   | Application name | Main Class                                     |
| ---------- | ---------------- | ---------------------------------------------- |
| ADS        | ads              | com.amazonaws.sfc.ads.AdsProtocolService       |
| J1939      | J1939            | com.amazonaws.sfc.j1939.J1939ProtocolService   |
| MQTT       | mqtt             | com.amazonaws.sfc.mqtt.MqttProtocolService     |
| Modbus TCP | modbus-tcp       | com.amazonaws.sfc.tcp.ModbusTcpProtocolService |
| NATS       | nats             | com.amazonaws.sfc.nats.NatsProtocolService     |
| OPCUA      | opcua            | com.amazonaws.sfc.opcua.OpcuaProtocolService   |
| PCCC       | pccc             | com.amazonaws.sfc.pccc.PcccProtocolService     |
| REST       | rest             | com.amazonaws.sfc.rest.RestProtocolService     |
| S7         | s7               | com.amazonaws.sfc.s7.S7ProtocolService         |
| SIMULATOR  | simulator        | com.amazonaws.sfc.simulator.SimularorService   |
| SLMP       | slmp             | com.amazonaws.sfc.slmp.SlmpProtocolService     |
| SNMP       | snmp             | com.amazonaws.sfc.snmp.SnmpProtocolService     |
| SQL        | sql              | com.amazonaws.sfc.sql.SqlProtocolService       |


The applications have the following command line parameters in common.

| Parameter     | Description                                                                                                                                                                                                                                                                                                                                                                                                              |
|---------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| -config       | Name of the configuration file. The only value used from the configuration file is the port number the process will listen on for IPC requests. The SFC core will send an initialization request to the service on this port with the configuration data for the service to initialize its communication with the source device.                                                                                         |
| -connection   | Security level used to secure traffic between SFC core and protocol adapter service. PlainText : No encryption ServerSideTLS : Data is encrypted, requires -cert and -key parameters MutualTLS : Data is encrypted, required -cert, ca and -key parameters The connection type must match the connection type, as set to the ConnectionType attribute for the client, to communicates with the protocol adapter service. |
| -cert         | Server certificate file to secure IPC (gRPC) traffic for connection types ServerSideTLS and MutualTLS                                                                                                                                                                                                                                                                                                                    |
| -key          | Server private file to secure IPC (gRPC) traffic for connection types ServerSideTLS and MutualTLS                                                                                                                                                                                                                                                                                                                        |
| -ca           | CA certificate file to secure IPC (gRPC) traffic for connection type MutualTLS                                                                                                                                                                                                                                                                                                                                           |
| -interface    | Name of the network interface used by SFC IPC communication (e.g., en0)                                                                                                                                                                                                                                                                                                                                                  |
| -envport      | The name of the environment variable that contains the port number for the service to listen on for requests.                                                                                                                                                                                                                                                                                                            |
| -error        | Set log output level to error level. (Error message only)                                                                                                                                                                                                                                                                                                                                                                |
| -h, -help     | Shows command line parameter help.                                                                                                                                                                                                                                                                                                                                                                                       |
| -info         | Set log output level to info level. (Info, warning and error messages)                                                                                                                                                                                                                                                                                                                                                   |
| -key          | Server key file to secure IPC (gRPC) traffic using SSL (optional).                                                                                                                                                                                                                                                                                                                                                       |
| -cert         | Server Certificate file to secure IPC (gRPC) traffic using SSL (optional).                                                                                                                                                                                                                                                                                                                                               |
| -nocolor      | Disable color coded output to console.                                                                                                                                                                                                                                                                                                                                                                                   |
| -port         | port number for the service to listen on for requests.                                                                                                                                                                                                                                                                                                                                                                   |
| -trace        | Set log output level to most detailed trace level (Info, warning, error, and detailed trace messages)                                                                                                                                                                                                                                                                                                                    |
| -warning      | Set log output level to warning level. (Error and warning messages)                                                                                                                                                                                                                                                                                                                                                      |

The port number, used by the service, can be specified using different methods which are applied in the following order:

- The value of the `-port` command line parameter
- The value of the environment variable specified by the `-envport` parameter
- From the `configuration file`, specified by the `-config` parameter, the port number for the server referred to in the
  ProtocolSource/Server element will be used

To protect the ICP traffic between the core and the adapter SSL can be used. For this, both the -cert and the -key
parameter must be used to specify the pathname to the certificate and the key file. If the -conf parameter is used then
the values of the Cert and Key elements of the server referred to in the ProtocolSource/Server element will be used.


## Running protocol adapters in-process

To run protocol adapters in the same process as the SFC core, they need to be implemented for the same JDK as used for
the core. To make it possible to add new adapters without making changes to the SFC code, there are no links in the core
to the libraries that implement the adapters. In the configuration of an in-process adapter type, the pathnames of the
jar files that contain the classes that implement the adapter need to be explicitly configured. When the SFC core
creates an instance of the adapter, it loads the configured jar files and uses a static factory method to create the
actual instance. 

The jar files are part of the adapter deployment and can be found in the lib directory of the deployment package. To
specify the path to the jar files it is recommended to use a placeholder, instead of hard-coding, the directory where
the adapter, and targets, are deployed and set an environment variable for this directory.

```sh
${<environment variable name>}/adapter name/lib/<jar file>
```

e.g., if the adapter is deployment tar file for an adapter, mqtt in this example, is deployed in `/sfc/mqtt` the
environment variable is set to "/sfc". In the configuration for the jar pathnames, this variable can be used as a
placeholder in the pathname of the jar file.

```sh
SFC_DEPLOYMENT_DIR=/sfc
```

In the configuration, the values for the jar files are "${SFC_DEPLOYMENT_DIR}/mqtt/lib".

Example AdapterTypes section, including the mqtt and opcua in-process protocol configuration with environment variable placeholders.
Each adapter is in a subdirectory with the name of the adapter in the deployment directory.

Used environment variable :


```json
{
  "AdapterTypes": {

    "MQTT": {
      "JarFiles": [
        "${SFC_DEPLOYMENT_DIR}/mqtt/lib"
      ],
      "FactoryClassName": "com.amazonaws.sfc.mqtt.MqttAdapter"
    },
    "OPCUA": {
      "JarFiles": [
        "${SFC_DEPLOYMENT_DIR}/opcua/lib"
      ],
      "FactoryClassName": "com.amazonaws.sfc.opcua.OpcuaAdapter"
    }
}


```



